name: Build and Release Artifacts

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Select runner type'
        required: true
        default: 'codebuild'
        type: choice
        options:
          - codebuild
          - ubuntu-latest
      build_linux:
        description: 'Build for Linux'
        required: false
        default: true
        type: boolean
      build_macos:
        description: 'Build for macOS (Apple Silicon)'
        required: false
        default: true
        type: boolean
      build_windows:
        description: 'Build for Windows'
        required: false
        default: true
        type: boolean
      build_packed_installers:
        description: 'Whether to build a Balleirna, ICP, and Integrator packed installers'
        default: true
        required:  true
        type: boolean
      ballerina_version:
        description: 'Specify Ballerina version to use'
        required: false
        type: string
      icp_version:
        description: 'Specify ICP version to use'
        required: false
        type: string
      integrator_version:
        description: 'Specify Integrator version to use'
        required: false
        type: string  

permissions:
  id-token: write
  contents: write     

env:
  awsRunnerId: codebuild-wso2_product-integrator-${{ github.run_id }}-${{ github.run_attempt }}  

jobs:
  compile:
    uses: ./.github/workflows/compile.yml
    secrets: inherit  
    with:
      runOnAWS: ${{ github.event.inputs.runner == 'codebuild' }}
      ballerina_version: ${{ github.event.inputs.ballerina_version }}
      icp_version: ${{ github.event.inputs.icp_version }}
      integrator_version: ${{ github.event.inputs.integrator_version }}
      build_packed_installers: ${{ github.event.inputs.build_packed_installers == 'true' }}

  build-macos:
    if: ${{ github.event.inputs.build_macos == 'true' }}
    name: Build (macOS)
    runs-on: macos-latest
    needs: compile
    defaults:
      run:
        working-directory: lib/vscode
    strategy:
      matrix:
        arch: [arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: lib/vscode/.nvmrc
          cache: npm
          cache-dependency-path: lib/vscode/package-lock.json

      - name: Cache Rust toolchain (macOS)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-toolchain-macos-${{ matrix.arch }}-${{ hashFiles('lib/vscode/cli/Cargo.lock') }}
          restore-keys: |
            cargo-toolchain-macos-${{ matrix.arch }}-
            cargo-toolchain-macos-

      - name: Cache CLI compilation (macOS)
        id: cache-cli-macos
        uses: actions/cache@v4
        with:
          path: |
            lib/vscode/cli/target/
          key: cli-macos-${{ matrix.arch }}-${{ hashFiles('patches/*.diff', 'lib/vscode/cli/Cargo.lock', 'lib/vscode/cli/src/**/*.rs', 'lib/vscode/cli/Cargo.toml') }}
          restore-keys: |
            cli-macos-${{ matrix.arch }}-

      - name: Cache native modules (macOS)
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            lib/vscode/.build/node_modules_cache
          key: native-modules-macos-${{ matrix.arch }}-${{ hashFiles('lib/vscode/package-lock.json', 'patches/*.diff') }}
          restore-keys: |
            native-modules-macos-${{ matrix.arch }}-
            native-modules-macos-

      - name: Cache built-in extensions
        id: cache-extensions-macos
        uses: actions/cache@v4
        with:
          path: |
            lib/vscode/.build/builtInExtensions
            lib/vscode/.build/extensions
          key: extensions-shared-${{ hashFiles('patches/*.diff', 'ci/build/update-product.sh', 'lib/vscode/package.json') }}

      - name: Download compilation artifact
        uses: actions/download-artifact@v4
        with:
          name: compilation
          path: lib/vscode

      - name: Extract compilation output
        run: tar -xzf compilation.tar.gz

      - name: Download WI extension VSIX
        uses: actions/download-artifact@v4
        with:
          name: wi-extension-vsix
          path: wi/wi-extension

      - name: Install quilt (macOS)
        run: |
          brew install quilt

      - name: Apply patches (macOS)
        run: quilt push -a

      - name: Update product.json and branding
        working-directory: .
        run: |
          chmod +x ./ci/build/update-product.sh
          ./ci/build/update-product.sh

      - name: Validate Xcode tools (macOS)
        run: |
          xcode-select -p
          python3 -m pip install --user setuptools || true

      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          # Add ARM64 target for cross-compilation
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            rustup target add aarch64-apple-darwin
          else
            rustup target add x86_64-apple-darwin
          fi

      - name: Install dependencies
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: '1'
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm ci

      - name: Mixin distro modules
        run: |
          node build/azure-pipelines/distro/mixin-npm.ts || true
          node build/azure-pipelines/distro/mixin-quality.ts || true

      - name: Install builtin extensions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.cache-extensions-macos.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Extensions cache hit - using shared cached extensions"
          else
            echo "⬇️ Downloading built-in extensions"
            npm run download-builtin-extensions
          fi

      - name: Build client (macOS ${{ matrix.arch }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run gulp vscode-darwin-${{ matrix.arch }}-min-ci

      - name: Build CLI (macOS ${{ matrix.arch }})
        run: |
          source "$HOME/.cargo/env"
          cd cli
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            TARGET_DIR="./target/aarch64-apple-darwin/release"
            TARGET_TRIPLE="aarch64-apple-darwin"
          else
            TARGET_DIR="./target/x86_64-apple-darwin/release"
            TARGET_TRIPLE="x86_64-apple-darwin"
          fi
          
          if [ "${{ steps.cache-cli-macos.outputs.cache-hit }}" = "true" ]; then
            echo "✅ CLI cache hit - checking for cached CLI binary"
            if [ -f "$TARGET_DIR/code" ]; then
              echo "Cached CLI binary found and ready to use"
            else
              echo "⚠️ Cache hit but binary missing - rebuilding"
              cargo build --release --bin=code --target=$TARGET_TRIPLE
            fi
          else
            echo "❌ CLI cache miss - compiling CLI"
            cargo build --release --bin=code --target=$TARGET_TRIPLE
          fi
          
          # Set CLI_BIN path relative to parent directory (after cd ..)
          CLI_BIN="./cli/$TARGET_DIR/code"
          cd ..

          # Verify CLI binary was built
          if [ ! -f "$CLI_BIN" ]; then
            echo "CLI binary not found at $CLI_BIN" >&2
            find ./cli/target -type f -name code 2>/dev/null || true
            exit 1
          fi
          
          # Get CLI app name from the source product.json
          CLI_APP_NAME=$(node -p "require('./product.json').tunnelApplicationName")
          
          # Find the .app directory inside VSCode-darwin-arm64
          APP_DIR=$(find "../VSCode-darwin-${{ matrix.arch }}" -name "*.app" -type d | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "Error: Could not find .app directory in VSCode-darwin-${{ matrix.arch }}" >&2
            ls -la "../VSCode-darwin-${{ matrix.arch }}/"
            exit 1
          fi
          
          # Copy CLI to build output
          mkdir -p "$APP_DIR/Contents/Resources/app/bin"
          cp "$CLI_BIN" "$APP_DIR/Contents/Resources/app/bin/$CLI_APP_NAME"
          chmod +x "$APP_DIR/Contents/Resources/app/bin/$CLI_APP_NAME"

      - name: Re-package with CLI (macOS ${{ matrix.arch }})
        run: |
          # Re-create the zip with the CLI included
          mkdir -p ../artifacts
          (cd .. && zip -qry "artifacts/VSCode-darwin-${{ matrix.arch }}.zip" VSCode-darwin-${{ matrix.arch }})

      - name: Sign macOS application
        run: |
          # Find the app directory
          APP_DIR=$(find "../VSCode-darwin-${{ matrix.arch }}" -name "*.app" -type d | head -1)
          
          if [ -n "$APP_DIR" ]; then
            echo "Signing application: $APP_DIR"
            
            # Ad-hoc signing (for local development/testing)
            codesign --force --deep --sign - "$APP_DIR"
            
            # Verify the signature
            codesign --verify --verbose "$APP_DIR"
            
            echo "Application signed successfully"
          else
            echo "No .app directory found to sign"
          fi

      - name: Upload macOS artifacts
        if: ${{ github.event.inputs.build_packed_installers == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-darwin-${{ matrix.arch }}
          path: |
            lib/artifacts/*
          if-no-files-found: error
      
      - name: Zip the artifacts and copy artifacts
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          APP_DIR=$(find "../VSCode-darwin-${{ matrix.arch }}" -name "*.app" -type d | head -1)
          mkdir -p ../artifacts
          (cd .. && zip -qry "artifacts/VSCode-darwin-${{ matrix.arch }}.zip" VSCode-darwin-${{ matrix.arch }})
          cp ../artifacts/VSCode-darwin-${{ matrix.arch }}.zip ../../installers/mac/
      - name: Build macOS installer packages
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          ROOT_DIR=$(pwd)
          echo "Root dir: ${ROOT_DIR}"
          BALLERINA_VERSION="${{ github.event.inputs.ballerina_version }}"
          if [ "${{ matrix.arch }}" = "arm64" ]; then
          BALLERINA_ARCH="macos-arm"
          else
          BALLERINA_ARCH="macos"
          fi
          BALLERINA_URL="https://github.com/ballerina-platform/ballerina-distribution/releases/download/v${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake-${BALLERINA_ARCH}.zip"
          ICP_VERSION="${{ github.event.inputs.icp_version }}"
          ICP_URL="https://github.com/wso2/integration-control-plane/releases/download/v${ICP_VERSION}/wso2-integration-control-plane-${ICP_VERSION}.zip"
          INTEGRATOR_VERSION="${{ github.event.inputs.integrator_version }}"
          cd ./installers/mac
          wget -O ballerina.zip "$BALLERINA_URL"
          wget -O icp.zip "$ICP_URL"
          ./build.sh ballerina.zip VSCode-darwin-${{ matrix.arch }}.zip icp.zip $INTEGRATOR_VERSION ${{ matrix.arch }}
          cd ${ROOT_DIR}

      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Upload macOS artifacts to S3
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          S3_PATH="s3://${{ secrets.AWS_S3_BUCKET }}/wi/${{ github.run_id }}/"
          aws s3 cp installers/mac/*.pkg "${S3_PATH}" --recursive
      
      - name: Upload macOS artifacts
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Product-Integrator-Darwin-${{ matrix.arch }}
          path: |
            installers/mac/*.pkg
          if-no-files-found: error

      - name: cosign-installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: sigstore/cosign-installer@v3.5.0
      - name: Sign the pkg installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          cosign sign-blob installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg --output-certificate installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg.pem --output-signature installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg.sig --yes

      - name: Verify signature of the pkg installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          cosign verify-blob installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg --certificate installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg.pem --signature installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg.sig --certificate-identity=https://github.com/wso2/product-integrator/.github/workflows/build-and-release.yml@${{ github.ref }} --certificate-oidc-issuer=https://token.actions.githubusercontent.com
          
      - name: Generate Hashes for pkg installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          openssl dgst -sha256 -out installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg.sha256 installers/mac/wso2-integrator-${{ github.event.inputs.integrator_version }}-${{ matrix.arch }}.pkg

      - name: Upload Signatures and Hashes for pkg installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Signatures-and-Hashes-PKG
          path: |
            installers/mac/*.pem
            installers/mac/*.sig
            installers/mac/*.sha256
          if-no-files-found: error

  build-windows:
    if: ${{ github.event.inputs.build_windows == 'true' }}
    name: Build (Windows)
    runs-on: windows-latest
    needs: compile
    defaults:
      run:
        working-directory: lib/vscode
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: lib/vscode/.nvmrc
          cache: npm
          cache-dependency-path: lib/vscode/package-lock.json

      - name: Cache native modules (Windows)
        uses: actions/cache@v4
        with:
          path: |
            lib/vscode/node_modules
            lib/vscode/.build/node_modules_cache
          key: native-modules-windows-${{ hashFiles('lib/vscode/package-lock.json') }}
          restore-keys: |
            native-modules-windows-

      - name: Cache Rust toolchain (Windows)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-toolchain-windows-${{ hashFiles('lib/vscode/cli/Cargo.lock') }}
          restore-keys: |
            cargo-toolchain-windows-

      - name: Cache CLI compilation (Windows)
        id: cache-cli-windows
        uses: actions/cache@v4
        with:
          path: |
            lib/vscode/cli/target/
          key: cli-windows-${{ hashFiles('patches/*.diff', 'lib/vscode/cli/Cargo.lock', 'lib/vscode/cli/src/**/*.rs', 'lib/vscode/cli/Cargo.toml') }}
          restore-keys: |
            cli-windows-

      - name: Cache built-in extensions
        id: cache-extensions-windows
        uses: actions/cache@v4
        with:
          path: |
            lib/vscode/.build/builtInExtensions
            lib/vscode/.build/extensions
          key: extensions-shared-${{ hashFiles('patches/*.diff', 'ci/build/update-product.sh', 'lib/vscode/package.json') }}

      - name: Download compilation artifact
        uses: actions/download-artifact@v4
        with:
          name: compilation
          path: lib/vscode

      - name: Extract compilation output
        shell: pwsh
        run: tar -xzf compilation.tar.gz

      - name: Download WI extension VSIX
        uses: actions/download-artifact@v4
        with:
          name: wi-extension-vsix
          path: wi/wi-extension

      - name: Install Rsync (Windows)
        shell: pwsh
        run: |
          choco install -y rsync  

      - name: Apply patches (Windows)
        shell: bash
        run: |
          # Apply patches using git apply since Windows doesn't have quilt
          while IFS= read -r patch || [ -n "$patch" ]; do
            # Skip empty lines and comments
            [[ -z "$patch" || "$patch" =~ ^[[:space:]]*# ]] && continue
            echo "Applying patch: $patch"
            git apply "patches/$patch"
          done < patches/series

      - name: Update product.json and branding
        shell: bash
        working-directory: .
        run: |
          chmod +x ./ci/build/update-product.sh
          ./ci/build/update-product.sh

      - name: Install Rust toolchain (Windows)
        shell: pwsh
        run: |
          # Download and install Rust
          Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile "rustup-init.exe"
          ./rustup-init.exe -y --default-toolchain stable
          # Add Rust to PATH for this session
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"

      - name: Install OpenSSL (Windows)
        shell: pwsh
        run: |
          # Install vcpkg and OpenSSL
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg.exe install openssl:x64-windows-static
          # Set environment variables for OpenSSL
          $env:VCPKG_ROOT = "C:\vcpkg"
          $env:OPENSSL_DIR = "C:\vcpkg\installed\x64-windows-static"
          # Make environment variables persistent for subsequent steps
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include" >> $env:GITHUB_ENV

      - name: Install dependencies
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: '1'
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm ci

      - name: Mixin distro modules
        run: |
          node build/azure-pipelines/distro/mixin-npm.ts || true
          node build/azure-pipelines/distro/mixin-quality.ts || true

      - name: Install builtin extensions
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.cache-extensions-windows.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Extensions cache hit - using shared cached extensions"
          else
            echo "⬇️ Downloading built-in extensions"
            npm run download-builtin-extensions
          fi

      - name: Download exlporer Dll
        shell: pwsh
        run: node build/win32/explorer-dll-fetcher.ts .build/win32/appx

      - name: Build client (Windows)
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run gulp "vscode-win32-x64-min-ci"

      - name: Build CLI (Windows)
        shell: pwsh
        env:
          VCPKG_ROOT: C:\vcpkg
          OPENSSL_DIR: C:\vcpkg\installed\x64-windows-static
          OPENSSL_LIB_DIR: C:\vcpkg\installed\x64-windows-static\lib
          OPENSSL_INCLUDE_DIR: C:\vcpkg\installed\x64-windows-static\include
          OPENSSL_STATIC: 1
        run: |
          # Add Rust to PATH
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"
          cd cli
          
          if ("${{ steps.cache-cli-windows.outputs.cache-hit }}" -eq "true") {
            Write-Host "✅ CLI cache hit - checking for cached CLI binary"
            if (Test-Path "./target/release/code.exe") {
              Write-Host "Cached CLI binary found and ready to use"
            } else {
              Write-Host "⚠️ Cache hit but binary missing - rebuilding"
              cargo build --release --bin=code
            }
          } else {
            Write-Host "❌ CLI cache miss - compiling CLI"
            cargo build --release --bin=code
          }
          
          # Verify CLI binary was built
          if (-not (Test-Path "./target/release/code.exe")) {
            Write-Host "CLI binary not found at ./target/release/code.exe" -ForegroundColor Red
            Get-ChildItem -Path ./target -Recurse -Name "code.exe" -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Mix in built CLI into client (Windows)
        shell: pwsh
        run: |
          cd cli
          $cliBin = "./target/release/code.exe"
          
          # Get CLI app name from source product.json (not from app bundle)
          $productJson = Get-Content "../product.json" | ConvertFrom-Json
          $cliAppName = $productJson.tunnelApplicationName + ".exe"
          
          # Create bin directory and copy CLI
          $binDir = "../VSCode-win32-x64/bin"
          New-Item -ItemType Directory -Path $binDir -Force
          Copy-Item $cliBin "$binDir/$cliAppName"

      - name: Re-package with CLI (Windows)
        shell: pwsh
        run: |
          # Re-create the zip with the CLI included
          mkdir -p ../artifacts
          $archivePath = "../artifacts/VSCode-win32-x64.zip"
          Remove-Item $archivePath -ErrorAction SilentlyContinue
          Compress-Archive -Path ../VSCode-win32-x64/* -DestinationPath $archivePath -Force

      - name: Upload Windows artifacts
        if: ${{ github.event.inputs.build_packed_installers == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-win32
          path: |
            lib/artifacts/*
          if-no-files-found: error
      
      - name: Copy Integrator artifact to build directory
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cp ../artifacts/VSCode-win32-x64.zip ../../installers/windows/
      - name: Build Windows installer packages
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        shell: pwsh
        run: |
          cd ..\..
          $ROOT_DIR = Get-Location
          Write-Host "Root dir: $ROOT_DIR"
          set BALLERINA_VERSION "${{ github.event.inputs.ballerina_version }}"
          set BALLERINA_URL "https://github.com/ballerina-platform/ballerina-distribution/releases/download/v${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake-windows.zip"
          set ICP_VERSION "${{ github.event.inputs.icp_version }}"
          set ICP_URL "https://github.com/wso2/integration-control-plane/releases/download/v${ICP_VERSION}/wso2-integration-control-plane-${ICP_VERSION}.zip"
          set INTEGRATOR_VERSION "${{ github.event.inputs.integrator_version }}"
          cd .\installers\windows
          Invoke-WebRequest -Uri $BALLERINA_URL -OutFile "ballerina.zip"
          Invoke-WebRequest -Uri $ICP_URL -OutFile "icp.zip"
          .\build.bat .\ballerina.zip .\VSCode-win32-x64.zip .\icp.zip $INTEGRATOR_VERSION

      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload Windows artifacts to S3
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          S3_PATH="s3://${{ secrets.AWS_S3_BUCKET }}/wi/${{ github.run_id }}/"
          aws s3 cp installers/windows/wso2-integrator-${{ github.event.inputs.integrator_version }}.msi "${S3_PATH}" --recursive

      - name: Upload Windows artifacts
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Product-Integrator-Windows
          path: |
            installers\windows\WixPackage\bin\x64\Release\en-US\*.msi
          if-no-files-found: error
      
      - name: cosign-installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: sigstore/cosign-installer@v3.5.0
      - name: Sign the msi installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          cosign sign-blob installers\windows\WixPackage\bin\x64\Release\en-US\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi --output-certificate installers\windows\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi.pem --output-signature installers\windows\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi.sig --yes
      - name: Verify signature of the msi installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          cosign verify-blob installers\windows\WixPackage\bin\x64\Release\en-US\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi --certificate installers\windows\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi.pem --signature installers\windows\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi.sig --certificate-identity=https://github.com/wso2/product-integrator/.github/workflows/build-and-release.yml@${{ github.ref }} --certificate-oidc-issuer=https://token.actions.githubusercontent.com

          
      - name: Generate Hashes for msi installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        run: |
          cd ../..
          openssl dgst -sha256 -out installers\windows\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi.sha256 installers\windows\WixPackage\bin\x64\Release\en-US\wso2-integrator-${{ github.event.inputs.integrator_version }}.msi 

      - name: Upload Signatures and Hashes for msi installer
        if: ${{ github.event.inputs.build_packed_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Signatures-and-Hashes-MSI
          path: |
            installers\windows\*.pem
            installers\windows\*.sig
            installers\windows\*.sha256
          if-no-files-found: error

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [compile, build-macos, build-windows]
    if: always() && (needs.compile.result == 'success') && (github.event.inputs.build_packed_installers == 'false')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create unified release artifact
        run: |
          mkdir -p release-artifacts
          
          # Copy Linux artifacts if available
          if [ -d "all-artifacts/artifacts-linux" ]; then
            cp all-artifacts/artifacts-linux/* release-artifacts/ || true
          fi
          
          # Copy macOS artifacts if available
          if [ -d "all-artifacts/artifacts-darwin-x64" ]; then
            cp all-artifacts/artifacts-darwin-x64/* release-artifacts/ || true
          fi
          if [ -d "all-artifacts/artifacts-darwin-arm64" ]; then
            cp all-artifacts/artifacts-darwin-arm64/* release-artifacts/ || true
          fi
          
          # Copy Windows artifacts if available
          if [ -d "all-artifacts/artifacts-win32" ]; then
            cp all-artifacts/artifacts-win32/* release-artifacts/ || true
          fi
          
          # List all created artifacts
          echo "Created release artifacts:"
          ls -la release-artifacts/

      - name: Upload unified release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wso2-integrator-release
          path: release-artifacts/*
          if-no-files-found: warn
