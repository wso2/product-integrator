name: Manual Build Artifacts

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: Build Linux artifacts
        required: false
        default: true
        type: boolean
      build_linux_installers:
        description: Build Linux installers (deb/rpm/tar)
        required: false
        default: false
        type: boolean
      build_macos:
        description: Build macOS artifacts
        required: false
        default: true
        type: boolean
      build_macos_installers:
        description: Build macOS installer (pkg)
        required: false
        default: false
        type: boolean
      build_windows:
        description: Build Windows installer
        required: false
        default: true
        type: boolean
      ballerina_version:
        description: Ballerina version (required for installers)
        required: false
        default: ""
        type: string
      icp_version:
        description: ICP version (required for installers)
        required: false
        default: ""
        type: string
      integrator_version:
        description: Integrator version (required for installers)
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  build-linux:
    if: ${{ inputs.build_linux == true || inputs.build_linux == 'true' }}
    name: Build Linux (build.sh)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Use Node from .nvmrc
        uses: actions/setup-node@v4
        with:
          node-version-file: lib/vscode/.nvmrc

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt libkrb5-dev libx11-dev libxkbfile-dev

      - name: Run build shell
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Validate installer inputs (Linux)
        if: ${{ inputs.build_linux_installers == true || inputs.build_linux_installers == 'true' }}
        run: |
          if [ -z "${{ inputs.ballerina_version }}" ] || [ -z "${{ inputs.icp_version }}" ] || [ -z "${{ inputs.integrator_version }}" ]; then
            echo "ballerina_version, icp_version, and integrator_version are required to build Linux installers."
            exit 1
          fi

      - name: Build Linux installers (deb/rpm/tar)
        if: ${{ inputs.build_linux_installers == true || inputs.build_linux_installers == 'true' }}
        run: |
          sudo apt-get install -y rpm unzip
          mkdir -p installers/linux-deb installers/linux-rpm installers/linux-tar
          if [ -d "VSCode-linux-x64" ]; then
            tar -czf vscode-linux-x64.tar.gz VSCode-linux-x64
          fi
          cp vscode-linux-x64.tar.gz installers/linux-deb/
          cp vscode-linux-x64.tar.gz installers/linux-rpm/
          cp vscode-linux-x64.tar.gz installers/linux-tar/

          BALLERINA_VERSION="${{ inputs.ballerina_version }}"
          BALLERINA_URL="https://github.com/ballerina-platform/ballerina-distribution/releases/download/v${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake-linux.zip"
          ICP_VERSION="${{ inputs.icp_version }}"
          ICP_URL="https://github.com/wso2/integration-control-plane/releases/download/v${ICP_VERSION}/wso2-integration-control-plane-${ICP_VERSION}.zip"
          INTEGRATOR_VERSION="${{ inputs.integrator_version }}"

          cd installers/linux-deb
          wget -O ballerina.zip "$BALLERINA_URL"
          wget -O icp.zip "$ICP_URL"
          ./build.sh ballerina.zip vscode-linux-x64.tar.gz icp.zip "$INTEGRATOR_VERSION"
          cd ../linux-rpm
          wget -O ballerina.zip "$BALLERINA_URL"
          wget -O icp.zip "$ICP_URL"
          ./build.sh ballerina.zip vscode-linux-x64.tar.gz icp.zip "$INTEGRATOR_VERSION"
          cd ../linux-tar
          wget -O ballerina.zip "$BALLERINA_URL"
          wget -O icp.zip "$ICP_URL"
          ./build.sh ballerina.zip vscode-linux-x64.tar.gz icp.zip "$INTEGRATOR_VERSION"
          cd ../..

      - name: Archive artifacts
        run: |
          mkdir -p release-artifacts
          for dir in VSCode-linux-*; do
            if [ -d "$dir" ]; then
              tar -czf "release-artifacts/${dir}.tar.gz" "$dir"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: release-artifacts/*

      - name: Upload Linux installer artifacts
        if: ${{ inputs.build_linux_installers == true || inputs.build_linux_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            installers/linux-deb/*.deb
            installers/linux-rpm/*.rpm
            installers/linux-tar/*.tar.gz
          if-no-files-found: error

  build-macos:
    if: ${{ inputs.build_macos == true || inputs.build_macos == 'true' }}
    name: Build macOS (build.sh)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Use Node from .nvmrc
        uses: actions/setup-node@v4
        with:
          node-version-file: lib/vscode/.nvmrc

      - name: Install system dependencies
        run: |
          brew install quilt

      - name: Run build shell
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Validate installer inputs (macOS)
        if: ${{ inputs.build_macos_installers == true || inputs.build_macos_installers == 'true' }}
        run: |
          if [ -z "${{ inputs.ballerina_version }}" ] || [ -z "${{ inputs.icp_version }}" ] || [ -z "${{ inputs.integrator_version }}" ]; then
            echo "ballerina_version, icp_version, and integrator_version are required to build macOS installers."
            exit 1
          fi

      - name: Build macOS installer
        if: ${{ inputs.build_macos_installers == true || inputs.build_macos_installers == 'true' }}
        run: |
          mkdir -p installers/mac
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            BALLERINA_ARCH="macos-arm"
          else
            BALLERINA_ARCH="macos"
          fi
          BALLERINA_VERSION="${{ inputs.ballerina_version }}"
          BALLERINA_URL="https://github.com/ballerina-platform/ballerina-distribution/releases/download/v${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake-${BALLERINA_ARCH}.zip"
          ICP_VERSION="${{ inputs.icp_version }}"
          ICP_URL="https://github.com/wso2/integration-control-plane/releases/download/v${ICP_VERSION}/wso2-integration-control-plane-${ICP_VERSION}.zip"
          INTEGRATOR_VERSION="${{ inputs.integrator_version }}"

          APP_DIR=$(find "VSCode-darwin-${ARCH}" -name "*.app" -type d | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "No .app found under VSCode-darwin-${ARCH}" >&2
            exit 1
          fi
          zip -qry "VSCode-darwin-${ARCH}.zip" "VSCode-darwin-${ARCH}"
          cp "VSCode-darwin-${ARCH}.zip" installers/mac/

          cd installers/mac
          curl -L "$BALLERINA_URL" -o ballerina.zip
          curl -L "$ICP_URL" -o icp.zip
          ./build.sh ballerina.zip "VSCode-darwin-${ARCH}.zip" icp.zip "$INTEGRATOR_VERSION"
          cd ../..

      - name: Archive artifacts
        run: |
          mkdir -p release-artifacts
          for dir in VSCode-darwin-*; do
            if [ -d "$dir" ]; then
              zip -Xry "release-artifacts/${dir}.zip" "$dir"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: release-artifacts/*

      - name: Upload macOS installer artifacts
        if: ${{ inputs.build_macos_installers == true || inputs.build_macos_installers == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: |
            installers/mac/*.pkg
          if-no-files-found: error

  build-windows:
    if: ${{ inputs.build_windows == true || inputs.build_windows == 'true' }}
    name: Build Windows installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Validate installer inputs
        shell: pwsh
        run: |
          if (-not "${{ inputs.ballerina_version }}" -or -not "${{ inputs.icp_version }}" -or -not "${{ inputs.integrator_version }}") {
            Write-Error "ballerina_version, icp_version, and integrator_version are required to build the Windows installer."
            exit 1
          }

      - name: Use Node from .nvmrc
        uses: actions/setup-node@v4
        with:
          node-version-file: lib/vscode/.nvmrc
          cache: npm
          cache-dependency-path: lib/vscode/package-lock.json

      - name: Install Rsync (Windows)
        shell: pwsh
        run: |
          choco install -y rsync

      - name: Install Rust toolchain (Windows)
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile "rustup-init.exe"
          ./rustup-init.exe -y --default-toolchain stable
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"

      - name: Install OpenSSL (Windows)
        shell: pwsh
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg.exe install openssl:x64-windows-static
          $env:VCPKG_ROOT = "C:\vcpkg"
          $env:OPENSSL_DIR = "C:\vcpkg\installed\x64-windows-static"
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include" >> $env:GITHUB_ENV

      - name: Run Windows build script
        shell: pwsh
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: '1'
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCODE_ARCH: x64
        run: |
          .\build.bat

      - name: Build CLI (Windows)
        shell: pwsh
        working-directory: lib/vscode
        env:
          VCPKG_ROOT: C:\vcpkg
          OPENSSL_DIR: C:\vcpkg\installed\x64-windows-static
          OPENSSL_LIB_DIR: C:\vcpkg\installed\x64-windows-static\lib
          OPENSSL_INCLUDE_DIR: C:\vcpkg\installed\x64-windows-static\include
          OPENSSL_STATIC: 1
        run: |
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"
          cd cli
          cargo build --release --bin=code
          if (-not (Test-Path "./target/release/code.exe")) {
            Write-Host "CLI binary not found at ./target/release/code.exe" -ForegroundColor Red
            exit 1
          }

      - name: Mix in built CLI into client (Windows)
        shell: pwsh
        working-directory: lib/vscode
        run: |
          cd cli
          $cliBin = "./target/release/code.exe"
          $productJson = Get-Content "../product.json" | ConvertFrom-Json
          $cliAppName = $productJson.tunnelApplicationName + ".exe"
          $binDir = "../VSCode-win32-x64/bin"
          New-Item -ItemType Directory -Path $binDir -Force
          Copy-Item $cliBin "$binDir/$cliAppName"

      - name: Re-package with CLI (Windows)
        shell: pwsh
        working-directory: lib/vscode
        run: |
          mkdir -p ../artifacts
          $archivePath = "../artifacts/VSCode-win32-x64.zip"
          Remove-Item $archivePath -ErrorAction SilentlyContinue
          Compress-Archive -Path ../VSCode-win32-x64/* -DestinationPath $archivePath -Force

      - name: Copy Integrator artifact to build directory
        working-directory: lib/vscode
        run: |
          cp ../artifacts/VSCode-win32-x64.zip ../../installers/windows/

      - name: Build Windows installer packages
        shell: pwsh
        working-directory: lib/vscode
        run: |
          cd ..\..
          $ROOT_DIR = Get-Location
          Write-Host "Root dir: $ROOT_DIR"
          set BALLERINA_VERSION "${{ inputs.ballerina_version }}"
          set BALLERINA_URL "https://github.com/ballerina-platform/ballerina-distribution/releases/download/v${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake-windows.zip"
          set ICP_VERSION "${{ inputs.icp_version }}"
          set ICP_URL "https://github.com/wso2/integration-control-plane/releases/download/v${ICP_VERSION}/wso2-integration-control-plane-${ICP_VERSION}.zip"
          set INTEGRATOR_VERSION "${{ inputs.integrator_version }}"
          cd .\installers\windows
          Invoke-WebRequest -Uri $BALLERINA_URL -OutFile "ballerina.zip"
          Invoke-WebRequest -Uri $ICP_URL -OutFile "icp.zip"
          .\build.bat .\ballerina.zip .\VSCode-win32-x64.zip .\icp.zip $INTEGRATOR_VERSION

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            installers\windows\WixPackage\bin\x64\Release\en-US\*.msi
          if-no-files-found: error
