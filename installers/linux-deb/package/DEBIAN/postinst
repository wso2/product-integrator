#!/usr/bin/env bash
#
# Copyright (c) WSO2. All rights reserved.

# Change ownership and permissions for integrator files
chown -R root:root /usr/share/wso2-integrator
chmod 4755 /usr/share/wso2-integrator/chrome-sandbox 2>/dev/null || true

# Create symlinks to /usr/bin
rm -f /usr/bin/wso2-integrator
ln -s /usr/share/wso2-integrator/bin/wso2-integrator /usr/bin/wso2-integrator
ln -s /usr/lib/ballerina/bin/bal /usr/bin/bal

# Set BALLERINA_HOME environment variable
echo 'export BALLERINA_HOME=/usr/lib/ballerina' > /etc/profile.d/wso2.sh
chmod 0755 /etc/profile.d/wso2.sh

# Register in the alternatives system
# Priority of 0 should never make wso2-integrator the default editor in auto mode
update-alternatives --install /usr/bin/editor editor /usr/bin/wso2-integrator 0

# Install the desktop entry
if hash update-desktop-database 2>/dev/null; then
	update-desktop-database
fi

# Update mimetype database to pickup workspace mimetype
if hash update-mime-database 2>/dev/null; then
	update-mime-database /usr/share/mime
fi

# Delete all ballerina-version files from user homes
delete_user_bal_version() {
    local user_home=$1
    local username=$2
    local user_ballerina_dir="$user_home/.ballerina"
    
    if [ ! -d "$user_home" ] || [ "$user_home" = "/" ]; then
        return
    fi
    
    if [ -d "$user_ballerina_dir" ]; then
        find "$user_ballerina_dir" -type f -name "ballerina-version" -delete 2>/dev/null || true
        echo "Deleted ballerina-version files for user: $username"
    fi
}

# Process all regular users (UID >= 1000)
while IFS=: read -r username _ uid _ _ home _; do
    if [ "$uid" -ge 1000 ] && [ "$username" != "nobody" ]; then
        delete_user_bal_version "$home" "$username"
    fi
done < /etc/passwd 2>/dev/null || true

# Delete for root user
if [ -d "/root" ]; then
    delete_user_bal_version "/root" "root"
fi

# Set the integrator version as active ballerina version in system-wide location
BALLERINA_VERSION=""
if [ -f "/usr/lib/ballerina/ballerina_version" ]; then
    BALLERINA_VERSION=$(cat "/usr/lib/ballerina/ballerina_version")
    SYSTEM_BAL_VERSION_FILE="/usr/lib/ballerina/distributions/ballerina-version"
    
    # Create distributions directory if it doesn't exist
    mkdir -p "/usr/lib/ballerina/distributions"
    
    # Remove existing ballerina-version file if it exists
    if [ -f "$SYSTEM_BAL_VERSION_FILE" ]; then
        rm -f "$SYSTEM_BAL_VERSION_FILE"
        echo "Removed existing system-wide ballerina-version file"
    fi
    
    # Write version to system-wide location
    echo "$BALLERINA_VERSION" > "$SYSTEM_BAL_VERSION_FILE"
    chmod 644 "$SYSTEM_BAL_VERSION_FILE"
    echo "Set system-wide ballerina-version to $BALLERINA_VERSION"
fi
