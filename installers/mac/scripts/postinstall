#!/bin/bash

# postinstall script for WSO2 Integrator
# This script runs after the package installation

set -e

echo "Starting WSO2 Integrator post-installation..."

echo "Post-install script started"

echo "Setting system-wide permissions"

# Set permissions for /Library/Application Support/WSO2Integrator/Ballerina
if [ -d "/Library/Application Support/WSO2Integrator/Ballerina" ]; then
    cd "/Library/Application Support/WSO2Integrator/Ballerina"
    chown -R root:wheel "/Library/Application Support/WSO2Integrator/Ballerina"
    chmod -R ugo+r "/Library/Application Support/WSO2Integrator/Ballerina/distributions/ballerina-*"
    chmod -R ugo+rx "/Library/Application Support/WSO2Integrator/Ballerina/bin"
    find dependencies -type d -exec chmod ugo+rx {} \;
    chmod -R ugo+r "/Library/Application Support/WSO2Integrator/Ballerina/lib"
    chmod o-w .
    rm -f "/Library/Application Support/WSO2Integrator/Ballerina/bin/ballerina"
    rm -f /etc/paths.d/ballerina
    echo "Set permissions for Ballerina directory"
fi

USER_HOMES=$(dscl . list /Users NFSHomeDirectory | awk '$2 ~ /^\/Users\// {print $2}')

# set the integrator version as active ballerina version for all users
for USER_HOME in $USER_HOMES; do
    if [ ! -d "$USER_HOME" ]; then
        echo "Skipping non-existent home: $USER_HOME"
        continue
    fi
    
    USERNAME=$(basename "$USER_HOME")
    
    if [ "$USERNAME" = "Shared" ] || [ "$USERNAME" = "Guest" ]; then
        echo "Skipping system user: $USERNAME"
        continue
    fi
    
    USER_BAL_VERSION_FILE="$USER_HOME/.ballerina/ballerina-version"
    rm -f "$USER_BAL_VERSION_FILE"
    echo "Removed ballerina-version file for user: $USERNAME"
done

# Set permissions for the .app in /Library/Application Support/WSO2Integrator
if [ -d "/Library/Application Support/WSO2Integrator/WSO2 Integrator.app" ]; then
    chmod -R 755 "/Library/Application Support/WSO2Integrator/WSO2 Integrator.app"
    chown -R root:wheel "/Library/Application Support/WSO2Integrator/WSO2 Integrator.app"
    echo "Set permissions for application"
fi

echo "Post-install script completed successfully"

echo "WSO2 Integrator installation completed successfully!"

exit 0