#!/bin/bash

# postinstall script for WSO2 Integrator
# This script runs after the package installation

set -e

echo "Starting WSO2 Integrator post-installation..."

echo "Post-install script started"

echo "Setting permissions"

# Determine target directory
INSTALL_ROOT="${2:-$HOME}"
TARGET_ROOT="${INSTALL_ROOT}/Library/Application Support/WSO2Integrator"
BALLERINA_HOME="${TARGET_ROOT}/Ballerina"

echo "Target Root: ${TARGET_ROOT}"

# Set permissions for Ballerina
if [ -d "$BALLERINA_HOME" ]; then
    cd "$BALLERINA_HOME"
    # chown -R root:wheel "$BALLERINA_HOME"
    chmod -R ugo+rx "$BALLERINA_HOME/bin"
    if [ -d "$BALLERINA_HOME/dependencies" ]; then
        find dependencies -type d -exec chmod ugo+rx {} \;
        find dependencies -type f -exec chmod ugo+r {} \;
    fi
    chmod o-w .
    echo "Set permissions for Ballerina directory"
fi

USER_HOMES=$(dscl . list /Users NFSHomeDirectory | awk '$2 ~ /^\/Users\// {print $2}')

# set the integrator version as active ballerina version for all users
for USER_HOME in $USER_HOMES; do
    if [ ! -d "$USER_HOME" ]; then
        echo "Skipping non-existent home: $USER_HOME"
        continue
    fi
    
    USERNAME=$(basename "$USER_HOME")
    
    if [ "$USERNAME" = "Shared" ] || [ "$USERNAME" = "Guest" ]; then
        echo "Skipping system user: $USERNAME"
        continue
    fi
    
    USER_BAL_VERSION_FILE="$USER_HOME/.ballerina/ballerina-version"
    rm -f "$USER_BAL_VERSION_FILE"
    echo "Removed ballerina-version file for user: $USERNAME"
done

# Set permissions for the .app
if [ -d "${TARGET_ROOT}/WSO2 Integrator.app" ]; then
    chmod -R 755 "${TARGET_ROOT}/WSO2 Integrator.app"
    # chown -R root:wheel "${TARGET_ROOT}/WSO2 Integrator.app"
    echo "Set permissions for application"
fi

echo "Post-install script completed successfully"

echo "WSO2 Integrator installation completed successfully!"

exit 0