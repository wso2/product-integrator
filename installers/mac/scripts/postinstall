#!/bin/bash

# postinstall script for WSO2 Integrator
# This script runs after the package installation

set -e

# Redirect all output to a log file and also to system log
LOGFILE="/tmp/wso2-integrator-install.log"
exec > >(tee -a "$LOGFILE") 2>&1

echo "Starting WSO2 Integrator post-installation..."

echo "Post-install script started"

# Read Ballerina version
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BALLERINA_VERSION=""
if [ -f "$SCRIPT_DIR/ballerina_version" ]; then
    BALLERINA_VERSION=$(cat "$SCRIPT_DIR/ballerina_version")
fi

# Resolve target user and move app bundle to the user's Applications folder
CONSOLE_USER=$(stat -f%Su /dev/console)
USER_HOME=""
if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ]; then
    USER_HOME=$(dscl . -read "/Users/$CONSOLE_USER" NFSHomeDirectory 2>/dev/null | awk '{print $2}')
fi
if [ -z "$USER_HOME" ] && [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ]; then
    USER_HOME="/Users/$CONSOLE_USER"
fi

APP_SRC="/Applications/WSO2 Integrator.app"
APP_DEST="${USER_HOME}/Applications/WSO2 Integrator.app"
if [ -n "$USER_HOME" ] && [ -d "$APP_SRC" ]; then
    mkdir -p "${USER_HOME}/Applications"
    rm -rf "$APP_DEST"
    mv "$APP_SRC" "$APP_DEST"
fi

APP_ROOT="$APP_DEST"
if [ ! -d "$APP_ROOT" ]; then
    APP_ROOT="$APP_SRC"
fi

# Check if Ballerina needs to be installed into the app bundle
APP_BALLERINA_ROOT="$APP_ROOT/Contents/Resources/components/ballerina"
TARGET_BALLERINA_DIR="${APP_BALLERINA_ROOT}/ballerina-${BALLERINA_VERSION}"
if [ -n "$BALLERINA_VERSION" ] && [ -d "$TARGET_BALLERINA_DIR" ]; then
    echo "Ballerina version $BALLERINA_VERSION already exists in app bundle - skipping extraction"
else
    echo "Installing Ballerina version $BALLERINA_VERSION into app bundle"

    # Extract Ballerina from the bundled zip
    if [ -f "$SCRIPT_DIR/ballerina.zip" ]; then
        TEMP_EXTRACT="/tmp/wso2_ballerina_extract_$$"
        mkdir -p "$TEMP_EXTRACT"

        echo "Extracting Ballerina zip..."
        unzip -q "$SCRIPT_DIR/ballerina.zip" -d "$TEMP_EXTRACT"

        # Get the extracted folder name
        BALLERINA_FOLDER=$(ls -1 "$TEMP_EXTRACT" | head -1)

        # Create target directory
        mkdir -p "$APP_BALLERINA_ROOT"

        # Move extracted folder into app bundle
        echo "Installing Ballerina to $APP_BALLERINA_ROOT..."
        if [ -n "$BALLERINA_FOLDER" ] && [ -d "$TEMP_EXTRACT/$BALLERINA_FOLDER" ]; then
            rm -rf "$TARGET_BALLERINA_DIR"
            mv "$TEMP_EXTRACT/$BALLERINA_FOLDER" "$TARGET_BALLERINA_DIR"
        fi

        # Cleanup
        rm -rf "$TEMP_EXTRACT"
        echo "Ballerina installation completed"
    else
        echo "Warning: Ballerina zip not found at $SCRIPT_DIR/ballerina.zip"
    fi
fi

# Set permissions for the .app in the user home folder
if [ -d "$APP_ROOT" ] && [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ]; then
    CONSOLE_GROUP=$(id -gn "$CONSOLE_USER" 2>/dev/null || echo "staff")
    chmod -R 755 "$APP_ROOT"
    chown -R "$CONSOLE_USER":"$CONSOLE_GROUP" "$APP_ROOT"
    echo "Set permissions for application"
fi

echo "Post-install script completed successfully"

echo "WSO2 Integrator installation completed successfully!"

exit 0