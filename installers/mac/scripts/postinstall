#!/bin/bash

# postinstall script for WSO2 Integrator
# This script runs after the package installation

set -e

echo "Starting WSO2 Integrator post-installation..."

echo "Post-install script started"

echo "Setting system-wide permissions"

# Set permissions for /Library/Ballerina
if [ -d "/Library/Ballerina" ]; then
    cd /Library/Ballerina
    chown -R root:wheel "/Library/Ballerina"
    chmod -R ugo+r /Library/Ballerina/distributions/ballerina-*
    chmod -R ugo+rx /Library/Ballerina/bin
    find dependencies -type d -exec chmod ugo+rx {} \;
    chmod -R ugo+r /Library/Ballerina/lib
    chmod o-w .
    rm -f /Library/Ballerina/bin/ballerina
    rm -f /etc/paths.d/ballerina
    echo "/Library/Ballerina/bin" > /etc/paths.d/bal
    chmod -R 644 /etc/paths.d/bal
    echo "Set permissions for Ballerina directory"
fi

USER_HOMES=$(dscl . list /Users NFSHomeDirectory | awk '$2 ~ /^\/Users\// {print $2}')

# Delete all ballerina-version files from user homes
for USER_HOME in $USER_HOMES; do
    if [ ! -d "$USER_HOME" ]; then
        echo "Skipping non-existent home: $USER_HOME"
        continue
    fi
    
    USERNAME=$(basename "$USER_HOME")
    
    if [ "$USERNAME" = "Shared" ] || [ "$USERNAME" = "Guest" ]; then
        echo "Skipping system user: $USERNAME"
        continue
    fi

    # Delete all ballerina-version files recursively inside .ballerina directory
    if [ -d "$USER_HOME/.ballerina" ]; then
        find "$USER_HOME/.ballerina" -type f -name "ballerina-version" -delete
        echo "Deleted ballerina-version files for user: $USERNAME"
    fi
done

# Set the integrator version as active ballerina version in system-wide location
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BALLERINA_VERSION=""
if [ -f "$SCRIPT_DIR/ballerina_version" ]; then
    BALLERINA_VERSION=$(cat "$SCRIPT_DIR/ballerina_version")
    SYSTEM_BAL_VERSION_FILE="/Library/Ballerina/distributions/ballerina-version"
    
    # Remove existing ballerina-version file if it exists
    if [ -f "$SYSTEM_BAL_VERSION_FILE" ]; then
        rm -f "$SYSTEM_BAL_VERSION_FILE"
        echo "Removed existing system-wide ballerina-version file"
    fi
    
    # Write version to system-wide location
    echo "$BALLERINA_VERSION" > "$SYSTEM_BAL_VERSION_FILE"
    chmod 644 "$SYSTEM_BAL_VERSION_FILE"
    echo "Set system-wide ballerina-version to $BALLERINA_VERSION"
fi

# Set permissions for the .app in /Applications
if [ -d "/Applications/WSO2 Integrator.app" ]; then
    chmod -R 755 "/Applications/WSO2 Integrator.app"
    chown -R root:wheel "/Applications/WSO2 Integrator.app"
    echo "Set permissions for application"
fi

echo "Post-install script completed successfully"

echo "WSO2 Integrator installation completed successfully!"

exit 0